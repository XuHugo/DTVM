# ğŸ—ï¸ EVMåˆçº¦æ¶æ„è§£é‡Š

## ğŸ“‹ é—®é¢˜è§£ç­”

ä½ çš„é—®é¢˜éå¸¸å¥½ï¼ä¸ºä»€ä¹ˆmain_counter.rsè°ƒç”¨çš„æ˜¯`deploy`å’Œ`call`å‡½æ•°ï¼Œè€Œä¸æ˜¯counter.solä¸­çš„`increase`å’Œ`decrease`å‡½æ•°ï¼Ÿ

## ğŸ¯ EVMåˆçº¦çš„æ ‡å‡†æ¶æ„

### ğŸ“ Counter.solåŸå§‹ä»£ç ï¼š
```solidity
pragma solidity ^0.8.0;
 
contract counter{
    uint public count;
 
    function increase() public {
        count++;
    }
     
    function decrease() public{
        count--;
    }
}
```

### ğŸ”„ ç¼–è¯‘åçš„WASMå¯¼å‡ºå‡½æ•°ï¼š
```
(export "memory" (memory 0))
(export "__wasm_call_ctors" (func $__wasm_call_ctors))
(export "call" (func $call))
(export "deploy" (func $deploy))
```

## ğŸ¤” ä¸ºä»€ä¹ˆä¸ç›´æ¥å¯¼å‡º`increase`å’Œ`decrease`ï¼Ÿ

### è¿™æ˜¯**EVMçš„æ ‡å‡†æ¶æ„æ¨¡å¼**ï¼š

1. **ç»Ÿä¸€å…¥å£ç‚¹è®¾è®¡**ï¼š
   - æ‰€æœ‰åˆçº¦å‡½æ•°è°ƒç”¨éƒ½é€šè¿‡`call`å‡½æ•°è¿›å…¥
   - ä¸æ˜¯æ¯ä¸ªSolidityå‡½æ•°éƒ½å•ç‹¬å¯¼å‡ºä¸ºWASMå‡½æ•°

2. **å‡½æ•°é€‰æ‹©å™¨æœºåˆ¶**ï¼š
   - é€šè¿‡call dataçš„å‰4ä¸ªå­—èŠ‚æ¥åŒºåˆ†è°ƒç”¨å“ªä¸ªå‡½æ•°
   - å‡½æ•°é€‰æ‹©å™¨ = keccak256(å‡½æ•°ç­¾å).slice(0, 4)

3. **éƒ¨ç½²ä¸æ‰§è¡Œåˆ†ç¦»**ï¼š
   - `deploy`å‡½æ•°ï¼šåˆçº¦éƒ¨ç½²æ—¶çš„æ„é€ å‡½æ•°
   - `call`å‡½æ•°ï¼šè¿è¡Œæ—¶çš„ç»Ÿä¸€è°ƒç”¨å…¥å£

## ğŸ” å‡½æ•°é€‰æ‹©å™¨ç¤ºä¾‹

### Counteråˆçº¦çš„å‡½æ•°é€‰æ‹©å™¨ï¼š

| Solidityå‡½æ•° | å‡½æ•°ç­¾å | é€‰æ‹©å™¨ï¼ˆå‰4å­—èŠ‚ï¼‰ |
|-------------|---------|-----------------|
| `increase()` | `increase()` | `0xe8927fbc` |
| `decrease()` | `decrease()` | `0x2baeceb7` |
| `count()` | `count()` | `0x06661abd` |

### è°ƒç”¨æµç¨‹ï¼š
```
1. è®¾ç½®call data: [é€‰æ‹©å™¨(4å­—èŠ‚)] + [å‚æ•°æ•°æ®]
2. è°ƒç”¨ call() å‡½æ•°
3. call() å‡½æ•°è§£æé€‰æ‹©å™¨
4. æ ¹æ®é€‰æ‹©å™¨è°ƒç”¨å¯¹åº”çš„å†…éƒ¨å‡½æ•°
```

## ğŸ› ï¸ æ­£ç¡®çš„è°ƒç”¨æ–¹å¼

### å½“å‰çš„ç®€åŒ–æµ‹è¯•ï¼š
```rust
// å½“å‰æˆ‘ä»¬åªæ˜¯æµ‹è¯•åŸºæœ¬çš„callæœºåˆ¶
let call_results = inst.call_wasm_func("call", &[]);
```

### å®Œæ•´çš„EVMè°ƒç”¨åº”è¯¥æ˜¯ï¼š
```rust
// 1. è®¾ç½®call dataï¼ˆåŒ…å«å‡½æ•°é€‰æ‹©å™¨ï¼‰
let increase_selector = [0xe8, 0x92, 0x7f, 0xbc]; // increase()çš„é€‰æ‹©å™¨
// 2. é€šè¿‡EVM contextè®¾ç½®call data
context.set_call_data(&increase_selector);
// 3. è°ƒç”¨ç»Ÿä¸€çš„callå‡½æ•°
let call_results = inst.call_wasm_func("call", &[]);
```

## ğŸ“Š EVM vs ç›´æ¥WASMå¯¹æ¯”

### ä¼ ç»ŸWASMåˆçº¦ï¼š
```rust
// ç›´æ¥å¯¼å‡ºå‡½æ•°
(export "increase" (func $increase))
(export "decrease" (func $decrease))

// ç›´æ¥è°ƒç”¨
inst.call_wasm_func("increase", &[]);
inst.call_wasm_func("decrease", &[]);
```

### EVMæ ‡å‡†åˆçº¦ï¼š
```rust
// ç»Ÿä¸€å¯¼å‡º
(export "call" (func $call))
(export "deploy" (func $deploy))

// é€šè¿‡call dataè°ƒç”¨
context.set_call_data(&selector_and_params);
inst.call_wasm_func("call", &[]);
```

## ğŸ¯ ä¸ºä»€ä¹ˆé‡‡ç”¨EVMæ¶æ„ï¼Ÿ

### 1. **æ ‡å‡†å…¼å®¹æ€§**ï¼š
- ä¸ä»¥å¤ªåŠEVMå®Œå…¨å…¼å®¹
- æ”¯æŒç°æœ‰çš„Solidityå·¥å…·é“¾
- å…¼å®¹MetaMaskç­‰é’±åŒ…

### 2. **åŠ¨æ€è°ƒç”¨**ï¼š
- æ”¯æŒåŠ¨æ€å‡½æ•°è°ƒç”¨
- æ”¯æŒä»£ç†åˆçº¦æ¨¡å¼
- æ”¯æŒåˆçº¦å‡çº§

### 3. **å®‰å…¨æ€§**ï¼š
- ç»Ÿä¸€çš„å…¥å£ç‚¹ä¾¿äºå®‰å…¨æ£€æŸ¥
- æ ‡å‡†åŒ–çš„å‚æ•°ç¼–ç /è§£ç 
- é˜²æ­¢ç›´æ¥å‡½æ•°è°ƒç”¨ç»•è¿‡æ£€æŸ¥

## ğŸ”§ å½“å‰æµ‹è¯•çš„å±€é™æ€§

### æˆ‘ä»¬å½“å‰çš„æµ‹è¯•ï¼š
```rust
// ç®€åŒ–æµ‹è¯• - åªæµ‹è¯•callæœºåˆ¶
let call_results = inst.call_wasm_func("call", &[]);
```

### å®Œæ•´æµ‹è¯•éœ€è¦ï¼š
1. **è®¾ç½®æ­£ç¡®çš„call data**
2. **å®ç°å‡½æ•°é€‰æ‹©å™¨è§£æ**
3. **å¤„ç†å‡½æ•°å‚æ•°ç¼–ç /è§£ç **
4. **éªŒè¯è¿”å›å€¼**

## ğŸš€ ä¸‹ä¸€æ­¥æ”¹è¿›

### è¦å®ç°çœŸæ­£çš„å‡½æ•°è°ƒç”¨ï¼Œéœ€è¦ï¼š

1. **å®ç°call dataè®¾ç½®æœºåˆ¶**ï¼š
```rust
// è®¾ç½®increase()çš„call data
context.set_call_data(&[0xe8, 0x92, 0x7f, 0xbc]);
```

2. **éªŒè¯å‡½æ•°æ‰§è¡Œç»“æœ**ï¼š
```rust
// è°ƒç”¨increaseåï¼Œcountåº”è¯¥å¢åŠ 
let old_count = get_count();
call_increase();
let new_count = get_count();
assert_eq!(new_count, old_count + 1);
```

3. **å®ç°å®Œæ•´çš„ABIç¼–ç /è§£ç **ï¼š
```rust
// æ”¯æŒå¸¦å‚æ•°çš„å‡½æ•°è°ƒç”¨
// æ”¯æŒå¤æ‚è¿”å›å€¼è§£æ
```

## ğŸ’¡ æ€»ç»“

**ä½ çš„è§‚å¯Ÿéå¸¸å‡†ç¡®ï¼**

Counter.solä¸­ç¡®å®æœ‰`increase()`å’Œ`decrease()`å‡½æ•°ï¼Œä½†æ˜¯ï¼š

1. **EVMåˆçº¦ä¸ç›´æ¥å¯¼å‡ºè¿™äº›å‡½æ•°**
2. **è€Œæ˜¯é€šè¿‡ç»Ÿä¸€çš„`call`å‡½æ•° + call dataæœºåˆ¶æ¥è°ƒç”¨**
3. **è¿™æ˜¯EVMçš„æ ‡å‡†æ¶æ„ï¼Œç¡®ä¿ä¸ä»¥å¤ªåŠç”Ÿæ€çš„å…¼å®¹æ€§**

å½“å‰çš„æµ‹è¯•æ˜¯**åŸºç¡€æ¶æ„éªŒè¯**ï¼Œä¸‹ä¸€æ­¥éœ€è¦å®ç°**å®Œæ•´çš„EVMè°ƒç”¨æœºåˆ¶**æ¥çœŸæ­£è°ƒç”¨counter.solä¸­çš„å…·ä½“å‡½æ•°ã€‚

---

*æ–‡æ¡£ç”Ÿæˆæ—¶é—´: 2025å¹´8æœˆ5æ—¥*  
*çŠ¶æ€: âœ… EVMåˆçº¦æ¶æ„è§£é‡Šå®Œæˆ*