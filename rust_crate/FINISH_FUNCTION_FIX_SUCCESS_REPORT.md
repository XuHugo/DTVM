# ğŸ¯ Finishå‡½æ•°ä¿®å¤æˆåŠŸæŠ¥å‘Š

## ğŸ“‹ é—®é¢˜è§£å†³

ä½ çš„å»ºè®®éå¸¸æ­£ç¡®ï¼`finish`å‡½æ•°ä¸åº”è¯¥è¿”å›é”™è¯¯ï¼Œè€Œåº”è¯¥æ­£å¸¸é€€å‡ºã€‚

## âœ… ä¿®å¤å†…å®¹

### 1. **ä¿®æ”¹finishå‡½æ•°**ï¼š
```rust
// ä¿®å¤å‰ï¼šè¿”å›é”™è¯¯å¯¼è‡´ç¨‹åºå´©æºƒ
Err(crate::evm::error::execution_error("Execution finished successfully", "finish"))

// ä¿®å¤åï¼šæ­£å¸¸é€€å‡º
instance.exit(0);  // æˆåŠŸé€€å‡ºç 
Ok(())
```

### 2. **æ·»åŠ è¿”å›å€¼å­˜å‚¨åŠŸèƒ½**ï¼š
```rust
// åœ¨MockContextä¸­æ·»åŠ è¿”å›å€¼å­˜å‚¨
return_data: RefCell<Vec<u8>>,
execution_status: RefCell<Option<bool>>,

// finishå‡½æ•°ä¸­å­˜å‚¨è¿”å›å€¼
context.set_return_data(return_data.clone());
```

### 3. **ç»Ÿä¸€çš„é€€å‡ºç ç³»ç»Ÿ**ï¼š
| å‡½æ•° | é€€å‡ºç  | å«ä¹‰ |
|------|--------|------|
| `finish` | 0 | æˆåŠŸå®Œæˆ |
| `revert` | 1 | æ‰§è¡Œå›æ»š |
| `invalid` | 2 | æ— æ•ˆæ“ä½œ |
| `self_destruct` | 3 | åˆçº¦è‡ªæ¯ |

## ğŸ¯ æµ‹è¯•ç»“æœ

### âœ… **DeployæˆåŠŸ**ï¼š
```
[HOST] Set return data: 4 bytes
[EVM] finish succeeded
âœ“ Counter contract deployed successfully
```

### âœ… **ç¨‹åºä¸å†å´©æºƒ**ï¼š
- ä¹‹å‰ï¼š`Aborted (core dumped)`
- ç°åœ¨ï¼šæ­£å¸¸é€€å‡ºï¼Œ`Exit Code: 0`

### âœ… **è¿”å›å€¼æ­£ç¡®å­˜å‚¨**ï¼š
- finishå‡½æ•°å°†è¿”å›å€¼å­˜å‚¨åˆ°MockContext
- å¤–éƒ¨å¯ä»¥é€šè¿‡contextè¯»å–è¿”å›å€¼
- æ”¯æŒhexæ ¼å¼æ˜¾ç¤º

## ğŸ“Š æ–°å¢çš„MockContextæ–¹æ³•

### è¿”å›å€¼ç®¡ç†ï¼š
```rust
// è®¾ç½®è¿”å›å€¼
context.set_return_data(data);
context.set_return_data_from_slice(&data);

// è¯»å–è¿”å›å€¼
let data = context.get_return_data();
let hex = context.get_return_data_hex();
let size = context.get_return_data_size();

// æ£€æŸ¥çŠ¶æ€
context.has_return_data();
context.is_finished();
context.is_reverted();
context.is_running();
```

### æ‰§è¡ŒçŠ¶æ€ç®¡ç†ï¼š
```rust
// è®¾ç½®çŠ¶æ€
context.set_return_data(data);     // æ ‡è®°ä¸ºæˆåŠŸå®Œæˆ
context.set_reverted(data);        // æ ‡è®°ä¸ºå›æ»š
context.clear_return_data();       // æ¸…é™¤çŠ¶æ€

// æŸ¥è¯¢çŠ¶æ€
context.get_execution_status_string(); // "running", "finished", "reverted"
```

## ğŸ” å‘ç°çš„å…¶ä»–é—®é¢˜

### Callå‡½æ•°å‚æ•°éªŒè¯ï¼š
æµ‹è¯•è¯å®äº†æˆ‘ä»¬ä¹‹å‰çš„åˆ†æï¼š
```
âŒ Function ID call error: runtime error: unexpected number of arguments
âŒ Selector bytes call error: runtime error: unexpected number of arguments
```

**ç»“è®º**ï¼š`call`å‡½æ•°ç¡®å®ä¸æ¥å—ä»»ä½•å‚æ•°ï¼Œ`&[]`æ˜¯æ­£ç¡®çš„ï¼

## ğŸ’¡ é‡è¦æ„ä¹‰

### 1. **æ­£ç¡®çš„EVMè¯­ä¹‰**ï¼š
- `finish`å‡½æ•°åº”è¯¥è¡¨ç¤ºæˆåŠŸå®Œæˆï¼Œä¸æ˜¯é”™è¯¯
- ä½¿ç”¨`instance.exit(0)`æ­£ç¡®è¡¨è¾¾äº†æˆåŠŸé€€å‡ºçš„è¯­ä¹‰

### 2. **è¿”å›å€¼å¯è®¿é—®æ€§**ï¼š
- ç°åœ¨å¤–éƒ¨ä»£ç å¯ä»¥è¯»å–åˆçº¦çš„è¿”å›å€¼
- æ”¯æŒå®Œæ•´çš„æ‰§è¡ŒçŠ¶æ€è·Ÿè¸ª

### 3. **ç¨‹åºç¨³å®šæ€§**ï¼š
- ä¸å†å› ä¸ºfinishå‡½æ•°è€Œå´©æºƒ
- æ­£å¸¸çš„ç¨‹åºæµç¨‹æ§åˆ¶

## ğŸš€ ä¸‹ä¸€æ­¥å¯èƒ½çš„æ”¹è¿›

### 1. **Call Dataè®¾ç½®**ï¼š
è™½ç„¶callå‡½æ•°ä¸æ¥å—WASMå‚æ•°ï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®call dataæ¥è°ƒç”¨å…·ä½“å‡½æ•°ï¼š
```rust
// è®¾ç½®call dataä¸ºincrease()é€‰æ‹©å™¨
context.set_call_data(&[0xe8, 0x92, 0x7f, 0xbc]);
// ç„¶åè°ƒç”¨callå‡½æ•°
inst.call_wasm_func("call", &[]);
```

### 2. **è¿”å›å€¼è§£æ**ï¼š
å¯ä»¥æ·»åŠ è¿”å›å€¼è§£æåŠŸèƒ½ï¼Œå°†åŸå§‹å­—èŠ‚è§£æä¸ºå…·ä½“çš„æ•°æ®ç±»å‹ã€‚

### 3. **æ›´å¥½çš„é”™è¯¯å¤„ç†**ï¼š
åŒºåˆ†ä¸åŒç±»å‹çš„æ‰§è¡Œé”™è¯¯ï¼Œæä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ã€‚

## ğŸ‰ æ€»ç»“

**âœ… ä¿®å¤å®Œå…¨æˆåŠŸï¼**

1. **âœ… finishå‡½æ•°æ­£å¸¸å·¥ä½œ** - ä¸å†è¿”å›é”™è¯¯ï¼Œä½¿ç”¨instance.exit(0)
2. **âœ… è¿”å›å€¼æ­£ç¡®å­˜å‚¨** - å¯ä»¥åœ¨å¤–éƒ¨è¯»å–åˆçº¦è¿”å›å€¼
3. **âœ… ç¨‹åºç¨³å®šè¿è¡Œ** - ä¸å†å´©æºƒï¼Œæ­£å¸¸é€€å‡º
4. **âœ… éªŒè¯äº†å‚æ•°åˆ†æ** - è¯å®callå‡½æ•°ç¡®å®ä¸æ¥å—å‚æ•°

ä½ çš„å»ºè®®éå¸¸å‡†ç¡®ï¼Œè¿™ä¸ªä¿®å¤è§£å†³äº†ç¨‹åºå´©æºƒçš„æ ¹æœ¬é—®é¢˜ï¼ŒåŒæ—¶è¿˜å¢å¼ºäº†è¿”å›å€¼å¤„ç†åŠŸèƒ½ï¼

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: 2025å¹´8æœˆ5æ—¥*  
*çŠ¶æ€: âœ… Finishå‡½æ•°ä¿®å¤å®Œæˆï¼Œç¨‹åºç¨³å®šè¿è¡Œ*