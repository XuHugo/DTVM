# EVM Host Functions Rust实现完善需求文档

## 介绍

本项目需要完善Rust环境下的EVM ABI Mock Host Functions实现。当前的Rust实现基于C++版本的翻译，但存在一些不完善的地方，需要进行改进以确保功能的完整性和正确性。

## 需求

### 需求 1: 修复MockContext实现

**用户故事:** 作为开发者，我希望MockContext能够正确模拟EVM合约的执行环境，以便进行测试和开发。

#### 验收标准

1. 当创建MockContext时，应该正确处理合约代码的前缀（big-endian 4字节长度前缀）
2. 当获取合约代码时，应该返回带前缀的完整代码
3. 当设置和获取存储时，应该使用正确的键值格式
4. 当获取调用数据时，应该支持动态的调用数据而不是硬编码

### 需求 2: 完善Host API函数实现

**用户故事:** 作为WASM合约，我需要通过Host API与EVM环境交互，获取区块信息、账户状态等数据。

#### 验收标准

1. 当调用storage_store时，应该正确验证参数并打印调试信息
2. 当调用storage_load时，应该正确从存储中读取数据
3. 当调用各种getter函数时，应该返回正确格式的mock数据
4. 当发生错误时，应该设置正确的异常代码
5. 当调用finish/revert时，应该正确处理退出逻辑

### 需求 3: 改进错误处理和调试

**用户故事:** 作为开发者，我希望能够清楚地看到函数调用的调试信息和错误信息，以便进行问题排查。

#### 验收标准

1. 当调用关键函数时，应该打印调试信息（如storage操作）
2. 当发生内存访问错误时，应该提供清晰的错误信息
3. 当参数验证失败时，应该设置正确的异常代码
4. 当函数执行完成时，应该提供执行结果的反馈

### 需求 4: 添加缺失的功能

**用户故事:** 作为系统集成者，我需要确保所有EVM操作码对应的Host函数都得到正确实现。

#### 验收标准

1. 当调用加密函数（sha256, keccak256）时，应该返回正确的mock结果
2. 当调用数学运算函数（addmod, mulmod, expmod）时，应该返回一致的mock结果
3. 当调用合约交互函数时，应该正确处理mock环境的限制
4. 当调用代码相关函数时，应该正确处理合约代码的读取

### 需求 5: 优化项目结构

**用户故事:** 作为维护者，我希望代码结构清晰，易于理解和维护。

#### 验收标准

1. 当组织代码时，应该将相关功能分组
2. 当添加新功能时，应该遵循一致的命名约定
3. 当处理内存操作时，应该确保内存安全
4. 当添加依赖时，应该在Cargo.toml中正确声明